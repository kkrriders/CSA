# Render Deployment Fix Guide

## Issues Fixed

### 1. **Function Call Error** ‚úÖ FIXED
**Problem**: `main.py` was calling non-existent `get_database_client()` function
**Solution**: Changed to use `get_database()` which actually exists in `database.py`

### 2. **Missing Environment Variables** ‚úÖ FIXED
**Problem**: New features added environment variables not in `render.yaml`
**Solution**: Added all optional environment variables with safe defaults

### 3. **Heavy Dependencies** ‚úÖ OPTIMIZED
**Problem**: `scikit-learn` and `numpy` are large packages that might cause build timeouts
**Solution**: Created `requirements-prod.txt` without ML packages

---

## Quick Fix Steps

### Option 1: Use Lightweight Production Requirements (Recommended)

1. **Update render.yaml buildCommand**:
   ```yaml
   buildCommand: pip install -r requirements-prod.txt
   ```

2. **Commit and push**:
   ```bash
   git add .
   git commit -m "fix: Render deployment issues - use prod requirements"
   git push
   ```

### Option 2: Keep Full Requirements (May timeout on free tier)

1. **Just commit the fixes**:
   ```bash
   git add .
   git commit -m "fix: Render deployment - database connection and env vars"
   git push
   ```

---

## Environment Variables in Render Dashboard

Make sure these are set in your Render dashboard:

### Required:
- `MONGODB_URI` - Your MongoDB connection string
- `SECRET_KEY` - Auto-generated by Render ‚úÖ
- `OPENROUTER_API_KEY` - Your OpenRouter API key (if using LLM)

### Optional (can leave empty):
- `CACHE_ENABLED=false` - Disable Redis if not using
- `MAIL_USERNAME=""` - Leave empty to skip email features
- `MAIL_PASSWORD=""` - Leave empty to skip email features

---

## What Was Changed

### `app/main.py`
```python
# Before (BROKEN):
db = await get_database_client()  # ‚ùå Function doesn't exist

# After (FIXED):
db = get_database()  # ‚úÖ Correct function
if db:
    await create_indexes(db)
```

### `render.yaml`
Added optional environment variables:
```yaml
- key: REDIS_URL
  value: redis://localhost:6379
- key: CACHE_ENABLED
  value: false  # Disabled by default
- key: MAIL_USERNAME
  value: ""  # Empty = skip email features
```

### New File: `requirements-prod.txt`
Removed heavy packages for faster builds:
- ‚ùå scikit-learn (150MB+)
- ‚ùå numpy (50MB+)
- ‚ùå fastapi-mail (has heavy dependencies)
- ‚ùå pytest* (only needed for development)

---

## Testing the Fix

1. **Check build logs** in Render dashboard for errors
2. **Visit your API**: `https://your-app.onrender.com/`
3. **Check health**: `https://your-app.onrender.com/health`
4. **View docs**: `https://your-app.onrender.com/docs`

Expected response from `/health`:
```json
{"status": "healthy"}
```

---

## Troubleshooting

### Build still failing?

**Check build logs for**:
1. Python version mismatch
2. Missing system dependencies
3. Out of memory errors

**Solutions**:
- Use `requirements-prod.txt` (lighter)
- Upgrade to Render paid tier (more memory)
- Remove unused imports in code

### App crashes on startup?

**Check runtime logs for**:
1. MongoDB connection errors
2. Missing environment variables
3. Import errors

**Solutions**:
- Verify `MONGODB_URI` is set correctly
- Check all required env vars are set
- Ensure `CACHE_ENABLED=false` if no Redis

### Features not working?

**Missing features with prod requirements**:
- ML predictions (needs scikit-learn)
- Advanced statistics (needs numpy)

**Solutions**:
- Use full `requirements.txt` with paid Render plan
- Or implement simpler versions of ML features without sklearn

---

## Recommended Render Setup

### Free Tier (Current):
```yaml
buildCommand: pip install -r requirements-prod.txt
startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

Environment:
- `CACHE_ENABLED=false`
- `MAIL_USERNAME=""`
- No Redis, no heavy ML

**Works**: All core features, analytics, study plans (without ML predictions)

### Paid Tier ($7/month):
```yaml
buildCommand: pip install -r requirements.txt
startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

Add Redis service for caching.

**Works**: ALL features including ML predictions, caching, full analytics

---

## Next Steps

1. ‚úÖ Code fixes applied
2. ‚úÖ render.yaml updated
3. ‚è≥ **YOU DO**: Choose Option 1 or 2 above and push to trigger redeploy
4. ‚è≥ **YOU DO**: Monitor build in Render dashboard
5. ‚è≥ **YOU DO**: Test `/health` endpoint when deployed

---

## Summary

**What was broken**:
- Wrong function call in main.py
- Missing env vars for new features
- Potentially heavy dependencies

**What's fixed**:
- Correct database function usage
- All env vars added with safe defaults
- Lightweight prod requirements option

**Result**: Render should deploy successfully now! üöÄ
